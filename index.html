<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Producteurs Locaux - Morbihan</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Configuration pour que la carte prenne tout l'espace de l'iframe */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }

        /* Styles des Popups */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; }
        .popup-title { font-size: 1.1em; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #e67e22; margin-bottom: 5px;}
        .popup-category { font-size: 0.85em; text-transform: uppercase; color: #7f8c8d; font-weight: bold; margin-bottom: 5px; }
        .popup-desc { font-size: 0.95em; color: #34495e; }
        .popup-addr { font-size: 0.85em; color: #7f8c8d; margin-top: 8px; font-style: italic; }

        /* Styles des Marqueurs (√âpingles) */
        .marker-pin {
            width: 36px; height: 36px; border-radius: 50% 50% 50% 0;
            background: var(--marker-color, #95a5a6); 
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -18px 0 0 -18px;
            box-shadow: -3px 3px 5px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
        }
        .marker-pin i { transform: rotate(45deg); color: white; font-size: 16px; }

        /* L√©gende */
        .legend {
            padding: 10px; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: absolute; bottom: 30px; left: 20px; z-index: 1000; font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 15px; height: 15px; margin-right: 8px; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="legend">
        <strong>L√©gende</strong><br>
        <div class="legend-item"><div class="legend-color" style="background:#0077be;"></div>Mer & Hu√Ætres</div>
        <div class="legend-item"><div class="legend-color" style="background:#f1c40f;"></div>Lait & Fromage</div>
        <div class="legend-item"><div class="legend-color" style="background:#d35400;"></div>Bi√®res & Cidres</div>
        <div class="legend-item"><div class="legend-color" style="background:#c0392b;"></div>Viande & √âlevage</div>
        <div class="legend-item"><div class="legend-color" style="background:#27ae60;"></div>Mara√Æchage & V√©g√©tal</div>
        <div class="legend-item"><div class="legend-color" style="background:#8e44ad;"></div>√âpiceries & Vrac</div>
        <div class="legend-item"><div class="legend-color" style="background:#795548;"></div>Artisanat (Biscuits, etc.)</div>
    </div>

    <script>
        var map = L.map('map').setView([47.65, -2.80], 10);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Liste brute des producteurs
        const rawProducteurs = [
            { lat: 47.526, lng: -2.764, cat: "√âpicerie Vrac", nom: "Les Saveurs du Colibris", desc: "√âpicerie fine, vrac, produits locaux.", addr: "Sarzeau Centre" },
            { lat: 47.525, lng: -2.553, cat: "Ostr√©iculture", nom: "Les Viviers de Banast√®re", desc: "Hu√Ætres, coquillages, d√©gustation vue sur claires.", addr: "Le Tour-du-Parc" },
            { lat: 47.530, lng: -2.775, cat: "Ostr√©iculture", nom: "Les Viviers du Ruault", desc: "Hu√Ætres creuses de Bretagne, palourdes.", addr: "Sarzeau" },
            { lat: 47.570, lng: -2.970, cat: "Ostr√©iculture", nom: "Maison Quintin", desc: "Hu√Ætres de la Baie de Quiberon, fruits de mer.", addr: "Saint-Philibert" },
            { lat: 47.522, lng: -2.550, cat: "Ostr√©iculture", nom: "Les Huitres de la Ria de Penerf", desc: "Ostr√©iculteur, vente directe.", addr: "Le Tour-du-Parc" },
            { lat: 47.524, lng: -2.551, cat: "Ostr√©iculture", nom: "Jonathan Alfonso", desc: "Production et vente d'hu√Ætres.", addr: "Le Tour-du-Parc" },
            { lat: 47.610, lng: -2.825, cat: "Ostr√©iculture", nom: "Huitres Jegat", desc: "Ostr√©iculteur, vente d'hu√Ætres du Golfe.", addr: "Arradon" },
            { lat: 47.605, lng: -2.730, cat: "Ostr√©iculture", nom: "La Belle d'Ilur", desc: "Ostr√©iculteur, d√©gustation et vente.", addr: "S√©n√©" },
            { lat: 47.572, lng: -2.968, cat: "Poissonnerie", nom: "Les Viviers de St Phil", desc: "Vente de fruits de mer et crustac√©s au d√©tail.", addr: "Saint-Philibert" },
            { lat: 47.575, lng: -2.632, cat: "Produits Laitiers", nom: "Ferme de Kerlis", desc: "Ferme laiti√®re, lait, cr√®me, fromages.", addr: "Surzur" },
            { lat: 47.505, lng: -2.730, cat: "Fromagerie", nom: "Ferme Fromag√®re de Suscinio", desc: "Tome de Rhuys, fromages vache.", addr: "Sarzeau" },
            { lat: 47.620, lng: -2.720, cat: "Fromagerie", nom: "Ferme de Kerlebik", desc: "Ch√®vrerie, crottins, tomme.", addr: "S√©n√©" },
            { lat: 47.665, lng: -2.985, cat: "Fromagerie", nom: "La Ferme Fromag√®re d'Auray", desc: "Fromages fermiers.", addr: "Auray" },
            { lat: 47.515, lng: -2.380, cat: "Fromagerie", nom: "Ferme de Kerdavid", desc: "Produits laitiers bio, gros lait.", addr: "Arzal" },
            { lat: 48.030, lng: -3.090, cat: "Fromagerie", nom: "Ferme de la Sablonni√®re", desc: "Fromages de vache bio.", addr: "Guern" },
            { lat: 47.578, lng: -2.636, cat: "Brasserie", nom: "Brasserie de Rhuys (La P'tite Mamm)", desc: "Bi√®re bio artisanale.", addr: "Surzur" },
            { lat: 47.695, lng: -2.655, cat: "Brasserie", nom: "Brasserie La Dilettante", desc: "Bi√®res locales (La Flemme).", addr: "Saint-Nolff" },
            { lat: 47.625, lng: -2.650, cat: "Brasserie", nom: "Brasserie Domani", desc: "Micro-brasserie artisanale.", addr: "Theix-Noyalo" },
            { lat: 47.580, lng: -2.640, cat: "Brasserie", nom: "Brasserie V√©n√®te‚ÄôS", desc: "Brasserie artisanale du Golfe.", addr: "Surzur" },
            { lat: 47.668, lng: -2.990, cat: "Brasserie", nom: "Microbrasserie Loch'Ale", desc: "Vente directe de bi√®res.", addr: "Auray" },
            { lat: 47.705, lng: -3.105, cat: "Brasserie", nom: "Brasserie de l'Estran", desc: "Bi√®res bio vari√©es.", addr: "Locoal-Mendon" },
            { lat: 47.630, lng: -2.660, cat: "Brasserie", nom: "Brasserie Mor Braz", desc: "Bi√®re √† l'eau de mer.", addr: "Theix" },
            { lat: 47.830, lng: -3.155, cat: "Brasserie", nom: "Brasserie L'Ane Dor√© (Kerazen)", desc: "Bi√®res artisanales.", addr: "Languidic" },
            { lat: 47.582, lng: -2.630, cat: "Cidrerie", nom: "Cidrerie De Rhuys NICOL", desc: "Cidre Royal Guillevic, jus.", addr: "Surzur" },
            { lat: 47.585, lng: -2.700, cat: "Cidrerie", nom: "La Maison Du Cidre", desc: "Mus√©e, boutique et cidre.", addr: "Le H√©zo" },
            { lat: 47.615, lng: -2.830, cat: "Cidrerie", nom: "Cidrerie du Golfe", desc: "Cidre bio, P'tit Fausset.", addr: "Arradon" },
            { lat: 47.700, lng: -3.100, cat: "Cidrerie", nom: "Cidrerie du Pays d'Auray", desc: "Cidre fermier.", addr: "Locoal-Mendon" },
            { lat: 47.656, lng: -2.760, cat: "Cidrerie", nom: "KYSTIN", desc: "Cidre artisanal haut de gamme.", addr: "Vannes" },
            { lat: 47.690, lng: -2.735, cat: "Viande", nom: "GAEC des 3 Horizons", desc: "Viande bovine Blonde d'Aquitaine.", addr: "Saint-Av√©" },
            { lat: 47.612, lng: -2.740, cat: "Volaille/Oeufs", nom: "Volailles Sinagotes", desc: "Volailles fermi√®res et oeufs.", addr: "S√©n√©" },
            { lat: 47.618, lng: -2.835, cat: "Viande", nom: "GAEC de La Ferme de l'Etang", desc: "Viande bovine et produits fermiers.", addr: "Arradon" },
            { lat: 47.760, lng: -2.780, cat: "Viande", nom: "La ferme de Kerdossen", desc: "Vente directe (viande, volaille).", addr: "Locqueltas" },
            { lat: 48.050, lng: -2.920, cat: "Viande/Epicerie", nom: "Ferme Lis Ar Parkou", desc: "Viande bovine, ≈ìufs, farine.", addr: "Noyal-Pontivy" },
            { lat: 47.675, lng: -2.570, cat: "Charcuterie", nom: "La ferme de Co√´t-Navalen", desc: "Porc, charcuterie √† la ferme.", addr: "Sulniac" },
            { lat: 47.575, lng: -2.720, cat: "Viande", nom: "La ferme de l'√Æle de Tascon", desc: "Viande bovine Aubrac insulaire.", addr: "Saint-Armel" },
            { lat: 47.680, lng: -2.950, cat: "Mara√Æchage", nom: "Le jardin du Penher", desc: "Producteur fruits et l√©gumes.", addr: "Pluneret" },
            { lat: 47.655, lng: -2.800, cat: "Mara√Æchage", nom: "Ferme de Kerverec", desc: "L√©gumes de saison.", addr: "Ploeren" },
            { lat: 47.560, lng: -2.620, cat: "Mara√Æchage", nom: "Le Jardin de Brarun", desc: "Vente directe fruits et l√©gumes.", addr: "Surzur" },
            { lat: 47.600, lng: -2.710, cat: "Mara√Æchage", nom: "La ferme de Bezidel", desc: "L√©gumes et produits fermiers.", addr: "S√©n√©" },
            { lat: 47.685, lng: -2.810, cat: "Mara√Æchage", nom: "Au fil des saisons", desc: "Mara√Æchage et produits de saison.", addr: "Plescop" },
            { lat: 47.630, lng: -2.850, cat: "Mara√Æchage/C√©r√©ales", nom: "Ferme de Lignol", desc: "Ferme bio, l√©gumes, farines.", addr: "Arradon" },
            { lat: 47.650, lng: -2.820, cat: "Mara√Æchage", nom: "La Cueillette Ploeren Arradon", desc: "Cueillette libre service.", addr: "Ploeren" },
            { lat: 47.710, lng: -3.120, cat: "Mara√Æchage", nom: "Ferme de Keruzerh", desc: "L√©gumes bio sol vivant.", addr: "Locoal-Mendon" },
            { lat: 47.576, lng: -2.633, cat: "√âpicerie Vrac", nom: "L'Odyss√©e du Vrac", desc: "Magasin vrac, z√©ro d√©chet.", addr: "Surzur" },
            { lat: 47.480, lng: -3.120, cat: "Conserverie", nom: "Conserverie La Quiberonnaise", desc: "Sardines mill√©sim√©es.", addr: "Quiberon" },
            { lat: 47.640, lng: -3.450, cat: "Conserverie", nom: "Groix & Nature", desc: "Rillettes de poissons, huile de homard.", addr: "√éle de Groix" },
            { lat: 47.980, lng: -3.100, cat: "Conserverie sucr√©e", nom: "Saveurs & Co", desc: "Confitures, tartinades.", addr: "Melrand" },
            { lat: 47.565, lng: -2.710, cat: "Conserverie sucr√©e", nom: "Les Confitures de Rapha√´l", desc: "Confitures artisanales.", addr: "Saint-Armel" },
            { lat: 47.520, lng: -2.780, cat: "Biscuiterie", nom: "Biscuiterie de la Presqu'√Æle", desc: "Kouign-Amann, g√¢teaux.", addr: "Sarzeau" },
            { lat: 47.586, lng: -2.702, cat: "Biscuiterie", nom: "Biscuiterie des V√©n√®tes", desc: "Biscuits bio, caramel.", addr: "Le H√©zo" },
            { lat: 48.065, lng: -2.965, cat: "Biscuiterie", nom: "Biscuiterie Joubard", desc: "Biscuits secs, gaufrettes.", addr: "Pontivy" },
            { lat: 47.865, lng: -2.880, cat: "H√©liciculture", nom: "Kerhelix", desc: "√âlevage d'escargots.", addr: "Plumelin" },
            { lat: 47.635, lng: -3.460, cat: "H√©liciculture", nom: "Escargots de l'√Æle de Groix", desc: "√âlevage insulaire.", addr: "√éle de Groix" },
            { lat: 47.740, lng: -3.080, cat: "Superaliment", nom: "Bretagne Spiruline", desc: "Producteur de spiruline.", addr: "Landaul" },
            { lat: 47.620, lng: -3.000, cat: "Superaliment", nom: "Kian Spiruline", desc: "Ferme de spiruline.", addr: "Crac'h" },
            { lat: 47.750, lng: -2.850, cat: "√âpices", nom: "Safran du Morbihan", desc: "Culture de safran.", addr: "Grand-Champ" },
            { lat: 47.840, lng: -2.720, cat: "Apiculture", nom: "L'Abeille de Lanvaux", desc: "Miels de sarrasin, for√™t.", addr: "Saint-Jean-Br√©velay" },
            { lat: 47.955, lng: -2.550, cat: "Apiculture", nom: "Les Ruchers Delamarche", desc: "Miel, produits ruche.", addr: "Josselin" },
            { lat: 47.570, lng: -2.720, cat: "Sel", nom: "La Paludi√®re du Golfe", desc: "Sel de Gu√©rande r√©colt√© dans le Golfe.", addr: "Saint-Armel" },
            { lat: 47.656, lng: -2.763, cat: "√âpicerie Vrac", nom: "Les Bocaux Garnis", desc: "√âpicerie vrac, z√©ro d√©chet.", addr: "Vannes" },
            { lat: 47.658, lng: -2.770, cat: "Magasin Producteurs", nom: "Les Producteurs du Coin", desc: "Point de vente collectif.", addr: "Vannes" },
            { lat: 47.615, lng: -2.735, cat: "Magasin Bio", nom: "Le Local Bio", desc: "Magasin bio, produits locaux.", addr: "S√©n√©" }
        ];

        // SUPPRESSION DES DOUBLONS AUTOMATIQUE
        const uniqueProducteurs = [...new Map(rawProducteurs.map(item => [item.nom, item])).values()];

        // Fonction Styles
        function getStyleForCategory(cat) {
            if (["Ostr√©iculture", "Poissonnerie", "Sel", "Superaliment", "H√©liciculture"].some(c => cat.includes(c))) {
                return { color: "#0077be", icon: "fa-fish" };
            }
            if (["Fromagerie", "Produits Laitiers"].some(c => cat.includes(c))) {
                return { color: "#f1c40f", icon: "fa-cheese" };
            }
            if (["Brasserie", "Cidrerie"].some(c => cat.includes(c))) {
                return { color: "#d35400", icon: "fa-beer-mug-empty" };
            }
            if (["Viande", "Volaille", "Charcuterie"].some(c => cat.includes(c))) {
                return { color: "#c0392b", icon: "fa-cow" };
            }
            if (["Mara√Æchage", "√âpices", "Apiculture"].some(c => cat.includes(c))) {
                return { color: "#27ae60", icon: "fa-carrot" };
            }
            if (["√âpicerie", "Magasin", "Bio", "Producteurs"].some(c => cat.includes(c))) {
                return { color: "#8e44ad", icon: "fa-basket-shopping" };
            }
            if (["Conserverie", "Biscuiterie"].some(c => cat.includes(c))) {
                return { color: "#795548", icon: "fa-cookie-bite" };
            }
            return { color: "#95a5a6", icon: "fa-map-pin" };
        }

        // Cr√©ation des marqueurs
        uniqueProducteurs.forEach(prod => {
            const style = getStyleForCategory(prod.cat);
            const customIcon = L.divIcon({
                className: 'custom-marker-container',
                html: `<div class="marker-pin" style="--marker-color: ${style.color};"><i class="fa-solid ${style.icon}"></i></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -35]
            });

            var marker = L.marker([prod.lat, prod.lng], {icon: customIcon}).addTo(map);

            var popupContent = `
                <div class="custom-popup">
                    <div class="popup-title">${prod.nom}</div>
                    <div class="popup-category" style="color:${style.color}">${prod.cat}</div>
                    <div class="popup-desc">${prod.desc}</div>
                    <div class="popup-addr">üìç ${prod.addr}</div>
                </div>
            `;
            marker.bindPopup(popupContent);
            marker.on('mouseover', function (e) { this.openPopup(); });
        });
    </script>
</body>
</html>
